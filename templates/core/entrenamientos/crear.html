{% extends "base.html" %}

{% block title %}Crear Entrenamiento{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    
    <header class="mb-8">
        <nav class="text-sm mb-3 text-gray-500">
            <a href="{% url 'dashboard' %}" class="hover:text-primary">Dashboard</a>
            <span class="mx-2">/</span>
            <span class="text-gray-700 font-medium">Crear Entrenamiento</span>
        </nav>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
            ✨ Crear Nuevo Entrenamiento
        </h1>
    </header>
    {% if mesociclo_id %}
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    Añadiendo sesión a la <strong>Semana {{ semana|default:"1" }}</strong> del programa.
                </p>
            </div>
        </div>
    </div>
{% endif %}

    <form method="post" id="entrenamiento-form" enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors or detalle_formset.non_form_errors %}
            <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                <p class="font-medium">Errores en el formulario:</p>
                {{ form.non_field_errors }}
                {{ detalle_formset.non_form_errors }}
            </div>
        {% endif %}

        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8 mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b border-gray-200 pb-4">
                Información General
            </h2>
            <div class="space-y-6">
                {% for field in form %}
                <div>
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ field.label }}
                    </label>
                    {{ field }}
                    {% for error in field.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8 mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b border-gray-200 pb-4">
                Ejercicios
            </h2>
            
            {{ detalle_formset.management_form }}
            
            <div id="detalle-formset-container" class="space-y-6">
                {% for form_detalle in detalle_formset %}
                <div class="detalle-form-group ejercicio-item p-5 border border-gray-200 rounded-xl bg-white shadow-md relative">
                    {{ form_detalle.id.as_hidden }}
                    
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-lg font-bold text-primary">Ejercicio {{ forloop.counter }}</h4>
                        <div class="flex items-center space-x-2">
                            <button type="button" class="remove-ejercicio text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition" title="Eliminar ejercicio">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <div class="hidden">{{ form_detalle.DELETE }}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for field in form_detalle %}
                            {% if field.name != 'id' and field.name != 'DELETE' and field.name != 'entrenamiento' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ field.label }}
                                </label>
                                {{ field }}
                                {% for error in field.errors %}
                                    <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <template id="empty-detalle-form">
                <div class="detalle-form-group ejercicio-item p-5 border border-gray-200 rounded-xl bg-white shadow-md relative">
                    {{ detalle_formset.empty_form.id.as_hidden }}
                    
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-lg font-bold text-primary">Ejercicio __NUMERO__</h4>
                        <div class="flex items-center space-x-2">
                            <button type="button" class="remove-ejercicio text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition" title="Eliminar ejercicio">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <div class="hidden">{{ detalle_formset.empty_form.DELETE }}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for field in detalle_formset.empty_form %}
                            {% if field.name != 'id' and field.name != 'DELETE' and field.name != 'entrenamiento' %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ field.label }}
                                </label>
                                {{ field }}
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </template>

            <button type="button" id="add-detalle-form"
                    class="mt-6 w-full flex items-center justify-center px-4 py-2 border border-dashed border-primary text-sm font-medium rounded-md text-primary bg-indigo-50 hover:bg-indigo-100 transition duration-150">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Añadir Ejercicio
            </button>
        </div>

        <div class="pt-4 flex flex-col sm:flex-row-reverse gap-3">
            <button type="submit"
                    class="w-full inline-flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                Guardar y Configurar Series
            </button>
            <a href="{% url 'dashboard' %}" 
                class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const detalleContainer = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-detalle-form');
    const totalForms = document.querySelector('input[name="detalles-TOTAL_FORMS"]');
    const emptyFormTemplate = document.getElementById('empty-detalle-form');

    function actualizarNumeracion() {
        const items = detalleContainer.querySelectorAll('.ejercicio-item:not([style*="display: none"])');
        items.forEach((item, idx) => {
            const h4 = item.querySelector('h4');
            if(h4) {
                h4.textContent = `Ejercicio ${idx + 1}`;
            }
        });
    }

    function setupDeleteButtons(scope) {
        scope.querySelectorAll('.remove-ejercicio').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const grupo = newBtn.closest('.ejercicio-item');
                const deleteCheckbox = grupo.querySelector('input[name$="-DELETE"]');
                
                if (confirm('¿Estás seguro de que quieres eliminar este ejercicio?')) {
                    if(deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        grupo.style.display = 'none';
                    } else {
                        grupo.remove();
                    }
                    actualizarNumeracion();
                }
            });
        });
    }

    addButton.addEventListener('click', function() {
        const idx = parseInt(totalForms.value);
        let html = emptyFormTemplate.innerHTML;
        
        html = html.replace(/__prefix__/g, idx);
        const nuevoNumero = detalleContainer.querySelectorAll('.ejercicio-item:not([style*="display: none"])').length + 1;
        html = html.replace(/__NUMERO__/g, nuevoNumero);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html.trim();
        const newForm = tempDiv.firstChild;
        
        detalleContainer.appendChild(newForm);
        totalForms.value = idx + 1;
        
        setupDeleteButtons(newForm);
        actualizarNumeracion();
    });

    setupDeleteButtons(document);
    actualizarNumeracion();
});
</script>
{% endblock extra_js %}